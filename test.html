<div>Attendance Machine (a proof of concept) - Pranav Somalinga</div>
<br>
<button type="button" onclick="init()">Start</button>
<button type="button" onclick="breakCode()">Break</button>
<button type="button" onclick="refresh()">Refresh</button>
<!-- HTML Button -->
<button id="showArrayBtn" onclick="showArray()">Show Present</button>
<button id="showMissingBtn" onclick="showAbsent()">Show Absent</button>
<br>
<div id="webcam-container"></div>
<div id="label-container"></div>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
<script type="text/javascript">

    // figurine model
    const URL = "https://teachablemachine.withgoogle.com/models/M28B_0nhQ/";
    // https://teachablemachine.withgoogle.com/models/M28B_0nhQ/

    let model, webcam, labelContainer, maxPredictions;

    // data set
    var listPresent = ["Null"];
    var listAbsent = [];
    var listStudents = ["Shifu", "WallE", "Mantis", "Po"];

    // break button -- stop code execution 
    async function breakCode() {
        // break camera too?    
        document.removeEventListener("DOMContentLoaded", function () { }, false);
        document.removeEventListener("load", function () { }, false);
        document.write("");
    }

    async function refresh() {
        window.location.reload();
    }

    // Load the image model and setup the webcam
    async function init() {
        const modelURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";

        model = await tmImage.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();

        // webcam
        const flip = true; // want to flip?
        webcam = new tmImage.Webcam(200, 200, flip);
        await webcam.setup(); // promp webcam access
        await webcam.play();
        window.requestAnimationFrame(loop);

        // append elements to the page
        document.getElementById("webcam-container").appendChild(webcam.canvas);
        labelContainer = document.getElementById("label-container");
        for (let i = 0; i < maxPredictions; i++) { // and class labels
            labelContainer.appendChild(document.createElement("div"));
        }
    }

    // looping -- keep track 
    async function loop() {
        webcam.update(); // update the webcam frame
        await predict();
        window.requestAnimationFrame(loop);

    }

    // show present
    var myArray = [];
    var present = [];
    var indexes = [];
    var index = 0;
    function showArray() {
        document.body.innerHTML = ""; // needed
        for (let i = 0; i < myArray.length; i++) {
            if ((myArray[i]) != "Empty") {
                const newElement = document.createElement("p"); // needed
                newElement.textContent = myArray[i]; // needed
                //  present[i] = myArray[i];
                indexes[index] = i;
                index++;
                document.body.appendChild(newElement); // needed
            }
        }
    }

    function showAbsent() {
        document.body.innerHTML = "";
        for (let i = 0; i < listStudents.length; i++) {
            if (present.indexOf(listStudents[i]) == -1) {
                const nextElement = document.createElement("p"); // try changing between a and p 
                nextElement.textContent = listStudents[i];
                document.body.appendChild(nextElement);
            }
        }
    }

    // run the webcam image through the image model
    async function predict() {
        const prediction = await model.predict(webcam.canvas);
        for (let i = 0; i < maxPredictions; i++) {
            const classPrediction =
                prediction[i].className + ": " + prediction[i].probability.toFixed(1);
            labelContainer.childNodes[i].innerHTML = classPrediction;
            if (prediction[i].probability.toFixed(2) > 0.9) {
                document.getElementById("constantData").innerHTML = prediction[i].className;
                myArray[i] = prediction[i].className;
                // add present array data here?
                present[i] = prediction[i].className;
            }
            else {
                document.getElementById("constantData").innerHTML = "I AM CONFUSED";
            }
            constantData.appendChild(document.createElement("div"));
            var myList = document.getElementById("myList");
            var list = document.getElementById('demo');

            // stack
            var firstname = document.getElementById("constantData").innerHTML = prediction[i].className;
            var entry = document.createElement('li');
            if (prediction[i].probability.toFixed(2) > 0.9) { // parameter toFixed(x) --> significance?
                entry.appendChild(document.createTextNode(firstname));
                list.appendChild(entry);
            }

        }
    }
</script>

<!--attemping to make the data easier to read-->
<br>
<textarea id="textArea">
 </textarea>

<br />
<button onclick="downloadFile()"> save File </button>
<script>
    function downloadFile() {
        var textToWrite = document.getElementById('textArea').innerHTML;
        var textFileAsBlob = new Blob([textToWrite], { type: 'text/plain' });
        var fileNameToSaveAs = "file.txt"; //filename.extension

        var downloadLink = document.createElement("a");
        downloadLink.download = fileNameToSaveAs;
        downloadLink.innerHTML = "Download File";
        if (window.webkitURL != null) {
            // Chrome allows the link to be clicked without actually adding it to the DOM.
            downloadLink.href = window.webkitURL.createObjectURL(textFileAsBlob);
        } else {
            // Firefox requires the link to be added to the DOM before it can be clicked.
            downloadLink.href = window.URL.createObjectURL(textFileAsBlob);
            downloadLink.onclick = destroyClickedElement;
            downloadLink.style.display = "none";
            document.body.appendChild(downloadLink);
        }

        downloadLink.click();
        var button = document.getElementById('save');
        button.addEventListener('click', saveTextAsFile);

        function destroyClickedElement(event) {
            // remove the link from the DOM
            document.body.removeChild(event.target);
        }
    }

</script>
<br><br>
<div id="constantData">
    What am I looking at:
</div>
<div id="presentStudents"> <!--this does not seem to be working-->
    Students I found:
</div>
<ol id="demo"></ol>