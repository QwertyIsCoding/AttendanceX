<div>Attendance Machine (a demo)- Pranav Somalinga</div>
<button type="button" onclick="init()">Start</button>
<button type="button" onclick="breakCode()">Break Code</button>
<!-- HTML Button -->
<button id="showArrayBtn" onclick="showArray()">Show Present</button>
<button id="showMissingBtn" onclick="showAbsent()">Show Absent</button>
<div id="webcam-container"></div>
<div id="label-container"></div>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
<script type="text/javascript">

    // figurine model
    const URL = "https://teachablemachine.withgoogle.com/models/M28B_0nhQ/";
    // https://teachablemachine.withgoogle.com/models/M28B_0nhQ/

    let model, webcam, labelContainer, maxPredictions;

    // data set
    var listPresent = [];
    var listAbsent = [];
    var listStudents = ["Shifu", "WallE", "Mantis"];

    // break button -- stop code execution 
    async function breakCode() {
        document.removeEventListener("DOMContentLoaded", function () { }, false);
        document.removeEventListener("load", function () { }, false);
        document.write("");
    }

    // Load the image model and setup the webcam
    async function init() {
        const modelURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";

        model = await tmImage.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();

        // webcam
        const flip = true; // want to flip?
        webcam = new tmImage.Webcam(200, 200, flip);
        await webcam.setup(); // promp webcam access
        await webcam.play();
        window.requestAnimationFrame(loop);

        // append elements to the page
        document.getElementById("webcam-container").appendChild(webcam.canvas);
        labelContainer = document.getElementById("label-container");
        for (let i = 0; i < maxPredictions; i++) { // and class labels
            labelContainer.appendChild(document.createElement("div"));
        }
    }

    // currently does not do anythhing
    async function backgroundTimer() {
        setInterval(predict, 1000000000);
    }

    // looping -- keep track 
    async function loop() {
        webcam.update(); // update the webcam frame
        await predict();
        window.requestAnimationFrame(loop);

    }

    // show present
    var myArray = [];
    var present = [];
    function showArray() {
        document.body.innerHTML = "";
        for (let i = 0; i < myArray.length; i++) {
            if ((myArray[i]) != "Empty") {
                const newElement = document.createElement("p");
                newElement.textContent = myArray[i];
                present[i] = myArray[i];
                document.body.appendChild(newElement);
            }
        }
    }

    
    /* WORK ON THIS TOMORROW
    function showAbsent() {
        document.body.innetHTML = "";
        for (let i = 0; i < present.length; i++) {
            for (let j = 0; j < myArray.length; j++) {
                if (myArray[i] )
            }
        }
    }
    */

    // run the webcam image through the image model
    async function predict() {
        const prediction = await model.predict(webcam.canvas);
        for (let i = 0; i < maxPredictions; i++) {
            const classPrediction =
                prediction[i].className + ": " + prediction[i].probability.toFixed(1);
            labelContainer.childNodes[i].innerHTML = classPrediction;
            if (prediction[i].probability.toFixed(2) > 0.9) {
                document.getElementById("constantData").innerHTML = prediction[i].className;
                myArray[i] = prediction[i].className;
            }
            else {
                document.getElementById("constantData").innerHTML = "I AM CONFUSED";
            }
            constantData.appendChild(document.createElement("div"));
            var myList = document.getElementById("myList");
            var list = document.getElementById('demo');

            // stack
            var firstname = document.getElementById("constantData").innerHTML = prediction[i].className;
            var entry = document.createElement('li');
            if (prediction[i].probability.toFixed(2) > 0.9) { // parameter toFixed(x) --> significance?
                entry.appendChild(document.createTextNode(firstname));
                list.appendChild(entry);
            }

        }
    }
</script>

<!--attemping to make the data easier to read-->
<div id="constantData">
    What am I looking at:
</div>
<div id="presentStudents"> <!--this does not seem to be working-->
    Students I found:
</div>
<ol id="demo"></ol>